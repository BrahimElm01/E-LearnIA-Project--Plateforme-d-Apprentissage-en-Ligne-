<div class="analytics-container">
  <!-- App Bar -->
  <div class="app-bar">
    <div class="app-bar-content">
      <div>
        <h1>Analyses</h1>
        <p>Dashboard professionnel - Statistiques compl√®tes</p>
      </div>
      <div class="app-bar-actions">
        <button class="icon-btn" (click)="navigateToHome()" title="Accueil">
          <span class="icon">üè†</span>
        </button>
      </div>
    </div>
  </div>

  <div class="content">
    @if (isLoading()) {
      <div class="loading">
        <div class="spinner">‚è≥</div>
        <p>Chargement des donn√©es...</p>
      </div>
    } @else if (errorMessage()) {
      <div class="error-message">
        <p>{{ errorMessage() }}</p>
        <button class="btn-primary" (click)="loadDashboardData()">R√©essayer</button>
      </div>
    } @else {
      <!-- Statistiques principales -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div class="stat-value">{{ dashboardStats()?.totalStudents || analytics()?.totalStudents || 0 }}</div>
          <div class="stat-label">√âtudiants totaux</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìö</div>
          <div class="stat-value">{{ dashboardStats()?.activeCourses || analytics()?.activeCourses || 0 }}</div>
          <div class="stat-label">Cours actifs</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìù</div>
          <div class="stat-value">{{ dashboardStats()?.totalQuizzes || quizzes().length }}</div>
          <div class="stat-label">Quizzes cr√©√©s</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚≠ê</div>
          <div class="stat-value">{{ formatNumber(dashboardStats()?.averageRating || analytics()?.averageRating || 0) }}</div>
          <div class="stat-label">Note moyenne</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-value">{{ formatNumber(dashboardStats()?.averageProgress || 0) }}%</div>
          <div class="stat-label">Progression moyenne</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-value">{{ dashboardStats()?.completedCourses || 0 }}</div>
          <div class="stat-label">Cours compl√©t√©s</div>
        </div>
      </div>

      <!-- Graphiques et visualisations -->
      <div class="charts-section">
        <div class="chart-card">
          <h2 class="section-title">R√©partition des √©tudiants</h2>
          <div class="chart-container">
            <div class="progress-chart">
              @for (item of getStudentsByProgress(); track item.label) {
                <div class="chart-item">
                  <div class="chart-label">
                    <span class="chart-color" [style.background-color]="item.color"></span>
                    <span>{{ item.label }}</span>
                  </div>
                  <div class="chart-bar-container">
                    <div class="chart-bar" [style.width.%]="(item.count / (allStudentProgress().length || 1)) * 100" [style.background-color]="item.color"></div>
                    <span class="chart-value">{{ item.count }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>

        <div class="chart-card">
          <h2 class="section-title">Top 5 cours populaires</h2>
          <div class="top-courses-list">
            @for (stat of getTopCourses(5); track stat.course.id) {
              <div class="top-item">
                <div class="top-item-info">
                  <h4>{{ stat.course.title }}</h4>
                  <p>{{ stat.enrollments }} inscriptions</p>
                </div>
                <div class="top-item-stats">
                  <div class="mini-stat">
                    <span class="mini-label">Progression</span>
                    <span class="mini-value">{{ formatNumber(stat.averageProgress) }}%</span>
                  </div>
                  <div class="mini-stat">
                    <span class="mini-label">Compl√©t√©s</span>
                    <span class="mini-value">{{ stat.completed }}</span>
                  </div>
                </div>
              </div>
            }
            @if (getTopCourses(5).length === 0) {
              <p class="empty-text">Aucun cours avec des inscriptions</p>
            }
          </div>
        </div>
      </div>

      <!-- Statistiques d√©taill√©es des cours -->
      <div class="section-card">
        <div class="section-header">
          <h2 class="section-title">Statistiques par cours</h2>
          <span class="section-count">{{ courseStats().length }} cours</span>
        </div>
        @if (courseStats().length === 0) {
          <div class="empty-state">
            <p>Aucune statistique disponible pour le moment</p>
          </div>
        } @else {
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Cours</th>
                  <th>Inscriptions</th>
                  <th>Progression moyenne</th>
                  <th>Compl√©t√©s</th>
                  <th>Note moyenne</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (stat of courseStats(); track stat.course.id) {
                  <tr>
                    <td>
                      <div class="course-cell">
                        <strong>{{ stat.course.title }}</strong>
                        <span class="course-status" [class.published]="stat.course.published">
                          {{ stat.course.published ? 'Publi√©' : 'Brouillon' }}
                        </span>
                      </div>
                    </td>
                    <td>
                      <span class="badge">{{ stat.enrollments }}</span>
                    </td>
                    <td>
                      <div class="progress-cell">
                        <div class="progress-bar-mini" [style.width.%]="stat.averageProgress" [style.background-color]="getProgressColor(stat.averageProgress)"></div>
                        <span>{{ formatNumber(stat.averageProgress) }}%</span>
                      </div>
                    </td>
                    <td>
                      <span class="badge badge-success">{{ stat.completed }}</span>
                    </td>
                    <td>
                      @if (stat.averageRating > 0) {
                        <span class="rating-badge" [style.background-color]="getRatingColor(stat.averageRating)">
                          ‚≠ê {{ formatNumber(stat.averageRating) }}
                        </span>
                      } @else {
                        <span class="no-rating">Non not√©</span>
                      }
                    </td>
                    <td>
                      <button class="btn-link" (click)="navigateToCourse(stat.course.id)">Voir</button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>

      <!-- Statistiques des quizzes -->
      <div class="section-card">
        <div class="section-header">
          <h2 class="section-title">Statistiques des quizzes</h2>
          <span class="section-count">{{ quizStats().length }} quizzes</span>
        </div>
        @if (quizStats().length === 0) {
          <div class="empty-state">
            <p>Aucun quiz cr√©√© pour le moment</p>
            <button class="btn-primary" (click)="navigateToQuizzes()">Cr√©er un quiz</button>
          </div>
        } @else {
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Quiz</th>
                  <th>Type</th>
                  <th>Tentatives</th>
                  <th>Score moyen</th>
                  <th>R√©ussis</th>
                  <th>√âchou√©s</th>
                  <th>Taux de r√©ussite</th>
                </tr>
              </thead>
              <tbody>
                @for (stat of quizStats(); track stat.quiz.id) {
                  <tr>
                    <td>
                      <strong>{{ stat.quiz.title }}</strong>
                      @if (stat.quiz.description) {
                        <p class="quiz-description">{{ stat.quiz.description }}</p>
                      }
                    </td>
                    <td>
                      @if (stat.quiz.courseId) {
                        <span class="badge badge-course">üìö Cours</span>
                      } @else {
                        <span class="badge badge-standalone">üéØ Standalone</span>
                      }
                    </td>
                    <td>
                      <span class="badge">{{ stat.totalAttempts }}</span>
                    </td>
                    <td>
                      @if (stat.totalAttempts > 0) {
                        <span class="score-badge" [style.background-color]="getProgressColor(stat.averageScore)">
                          {{ formatNumber(stat.averageScore) }}%
                        </span>
                      } @else {
                        <span class="no-data">Aucune tentative</span>
                      }
                    </td>
                    <td>
                      <span class="badge badge-success">{{ stat.passed }}</span>
                    </td>
                    <td>
                      <span class="badge badge-danger">{{ stat.failed }}</span>
                    </td>
                    <td>
                      @if (stat.totalAttempts > 0) {
                        <span class="success-rate" [style.color]="getProgressColor((stat.passed / stat.totalAttempts) * 100)">
                          {{ formatNumber((stat.passed / stat.totalAttempts) * 100) }}%
                        </span>
                      } @else {
                        <span class="no-data">N/A</span>
                      }
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>

      <!-- Top quizzes -->
      <div class="section-card">
        <h2 class="section-title">Top 5 quizzes les plus tent√©s</h2>
        <div class="top-quizzes-list">
          @for (stat of getTopQuizzes(5); track stat.quiz.id) {
            <div class="top-item">
              <div class="top-item-info">
                <h4>{{ stat.quiz.title }}</h4>
                <p>{{ stat.totalAttempts }} tentatives</p>
              </div>
              <div class="top-item-stats">
                <div class="mini-stat">
                  <span class="mini-label">Score moyen</span>
                  <span class="mini-value">{{ formatNumber(stat.averageScore) }}%</span>
                </div>
                <div class="mini-stat">
                  <span class="mini-label">R√©ussis</span>
                  <span class="mini-value">{{ stat.passed }}</span>
                </div>
              </div>
            </div>
          }
          @if (getTopQuizzes(5).length === 0) {
            <p class="empty-text">Aucun quiz avec des tentatives</p>
          }
        </div>
      </div>
    }
  </div>
</div>
